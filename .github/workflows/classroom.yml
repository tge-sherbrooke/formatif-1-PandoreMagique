name: Formatif F1 - V√©rification des tests locaux

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üîç V√©rifier que les tests ont √©t√© ex√©cut√©s
        id: check_markers
        run: |
          echo "V√©rification des marqueurs de tests locaux..."
          echo ""

          MARKER_DIR=".test_markers"
          ALL_PASSED=false

          # V√©rifier si le dossier des marqueurs existe
          if [ ! -d "$MARKER_DIR" ]; then
            echo "‚ùå ERREUR: Les tests locaux n'ont pas √©t√© ex√©cut√©s!"
            echo ""
            echo "üìö Instructions:"
            echo "   1. Sur le Raspberry Pi, ex√©cutez: python3 run_tests.py"
            echo "   2. Corrigez les erreurs si n√©cessaire"
            echo "   3. Pussez vos modifications: git add, git commit, git push"
            echo ""
            exit 1
          fi

          echo "‚úÖ Dossier des marqueurs trouv√©"

          # Compter les marqueurs
          MARKER_COUNT=$(find "$MARKER_DIR" -name "*.txt" | wc -l)
          echo "   Marqueurs trouv√©s: $MARKER_COUNT"

          # V√©rifier chaque marqueur
          if [ -f "$MARKER_DIR/ssh_key_verified.txt" ]; then
            echo "   ‚úÖ SSH key verified"
          else
            echo "   ‚ùå SSH key NOT verified"
          fi

          if [ -f "$MARKER_DIR/bmp280_script_verified.txt" ]; then
            echo "   ‚úÖ BMP280 script verified"
          else
            echo "   ‚ùå BMP280 script NOT verified"
          fi

          if [ -f "$MARKER_DIR/neoslider_script_verified.txt" ]; then
            echo "   ‚úÖ NeoSlider script verified"
          else
            echo "   ‚ö†Ô∏è  NeoSlider script NOT verified (optionnel)"
          fi

          if [ -f "$MARKER_DIR/hardware_detected.txt" ]; then
            echo "   ‚úÖ Hardware detected (Raspberry Pi)"
            cat "$MARKER_DIR/hardware_detected.txt" | grep -E "77|30" | head -2
          else
            echo "   ‚ÑπÔ∏è  Hardware scan non disponible (normal si pas sur Pi)"
          fi

          # V√©rifier que tous les tests obligatoires ont pass√©
          if [ -f "$MARKER_DIR/all_tests_passed.txt" ]; then
            echo ""
            echo "üéâ TOUS LES TESTS OBLIGATOIRES SONT PASS√âS!"
            ALL_PASSED=true
          else
            echo ""
            echo "‚ö†Ô∏è  Marqueur 'all_tests_passed.txt' manquant"
            echo "   Assurez-vous d'avoir ex√©cut√©: python3 run_tests.py"
          fi

          # Afficher le r√©sum√©
          if [ -f "$MARKER_DIR/test_summary.txt" ]; then
            echo ""
            echo "üìä R√©sum√© des tests:"
            cat "$MARKER_DIR/test_summary.txt"
          fi

          # Sauvegarder le r√©sultat pour les √©tapes suivantes
          echo "ALL_PASSED=$ALL_PASSED" >> $GITHUB_OUTPUT

      - name: üîç V√©rifier test_bmp280.py
        run: |
          echo "V√©rification de test_bmp280.py..."

          if [ ! -f "test_bmp280.py" ]; then
            echo "‚ùå ERREUR: test_bmp280.py introuvable!"
            echo "   Cr√©ez ce fichier selon les instructions du README.md"
            exit 1
          fi

          echo "‚úÖ test_bmp280.py trouv√©"

          # V√©rifier la syntaxe Python
          python3 -m py_compile test_bmp280.py
          echo "‚úÖ Syntaxe Python valide"

      - name: üîç V√©rifier test_neoslider.py
        run: |
          echo "V√©rification de test_neoslider.py..."

          if [ ! -f "test_neoslider.py" ]; then
            echo "‚ö†Ô∏è  test_neoslider.py introuvable (optionnel)"
            echo "   Ce fichier est optionnel pour le formatif F1"
          else
            echo "‚úÖ test_neoslider.py trouv√©"
            # V√©rifier la syntaxe Python
            python3 -m py_compile test_neoslider.py
            echo "‚úÖ Syntaxe Python valide"
          fi

      - name: üìä Rapport de validation
        if: always()
        run: |
          echo "## üìä R√©sultat de la validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Formatif F1** ‚Äî Introduction au Raspberry Pi et capteurs Adafruit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f ".test_markers/all_tests_passed.txt" ]; then
            echo "### ‚úÖ Tests locaux ex√©cut√©s avec succ√®s!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "L'√©tudiant a:" >> $GITHUB_STEP_SUMMARY
            echo "- Configur√© SSH sans mot de passe" >> $GITHUB_STEP_SUMMARY
            echo "- Cr√©√© le script test_bmp280.py" >> $GITHUB_STEP_SUMMARY
            echo "- Ex√©cut√© les tests localement sur le Raspberry Pi" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è Tests locaux non ex√©cut√©s" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "L'√©tudiant doit ex√©cuter \`python3 run_tests.py\` sur le Raspberry Pi." >> $GITHUB_STEP_SUMMARY
          fi

      - name: üí¨ Commentaire sur le PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let feedback = "## ü§ñ R√©sultats de la validation - Formatif F1\n\n";

            if (fs.existsSync('.test_markers/all_tests_passed.txt')) {
              feedback += "### ‚úÖ Tests locaux ex√©cut√©s avec succ√®s!\n\n";
              feedback += "Bravo! Vous avez:\n";
              feedback += "- ‚úÖ Configur√© SSH sans mot de passe\n";
              feedback += "- ‚úÖ Cr√©√© le script test_bmp280.py\n";
              feedback += "- ‚úÖ Ex√©cut√© les tests localement sur le Raspberry Pi\n\n";
              feedback += "Vous pouvez maintenant valider le fonctionnement mat√©riel avec:\n";
              feedback += "```bash\nuv run test_bmp280.py\nuv run test_neoslider.py\n```\n";
            } else {
              feedback += "### ‚ö†Ô∏è Tests locaux non ex√©cut√©s\n\n";
              feedback += "Pour compl√©ter le formatif:\n";
              feedback += "1. Connectez-vous au Raspberry Pi en SSH\n";
              feedback += "2. Clonez votre d√©p√¥t: `git clone <votre-d√©p√¥t>`\n";
              feedback += "3. Ex√©cutez: `python3 run_tests.py`\n";
              feedback += "4. Corrigez les erreurs si n√©cessaire\n";
              feedback += "5. Pussez: `git add . && git commit && git push`\n\n";
            }

            if (fs.existsSync('.test_markers/test_summary.txt')) {
              feedback += "### üìä D√©tails des tests:\n\n```\n";
              feedback += fs.readFileSync('.test_markers/test_summary.txt', 'utf8');
              feedback += "```\n";
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: feedback
            });
